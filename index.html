<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>App sopralluoghi - ZIP foto + questionario v35</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --c-text:#111827;
      --c-muted:#6b7280;
      --c-border:#e5e7eb;
      --c-card:#ffffff;
      --c-bg:#f5f5f5;
      --bg-head:#eef2ff;
      --bg-risk:#ecfeff;
      --bg-unita:#ecfdf5;
      --bg-summary:#fff7ed;
      --bg-notes:#fdf2f8;
      --bg-actions:#f1f5f9;
      --bg-log:#111827;
    }

    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:0;padding:.8rem;background:var(--c-bg);color:var(--c-text);}
    h1{font-size:1.12rem;margin:0 0 .55rem 0;}

    .card{background:var(--c-card);border-radius:12px;padding:.65rem .8rem;margin-bottom:.7rem;box-shadow:0 1px 3px rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.02);}
    .card.head{background:var(--bg-head);}
    .card.risk{background:var(--bg-risk);}
    .card.unita{background:var(--bg-unita);}
    .card.summary{background:var(--bg-summary);}
    .card.notes{background:var(--bg-notes);}
    .card.actions{background:var(--bg-actions);}
    .card.log{background:#0b1220;color:#e5e7eb;}

    .titleRow{display:flex;align-items:center;justify-content:space-between;gap:.6rem;flex-wrap:wrap}
    .titleRow strong{font-size:.95rem}
    .icon{font-size:1.02rem}

    label{display:block;font-size:.78rem;margin-top:.35rem;margin-bottom:.12rem;}
    input[type="text"],input[type="number"],select,textarea,button{
      width:100%;box-sizing:border-box;font-size:.88rem;margin-bottom:.28rem;padding:.35rem .45rem;
    }
    textarea{min-height:70px;resize:vertical;}

    button{border-radius:10px;border:1px solid rgba(0,0,0,.08);cursor:pointer;background:#fff;}
    button.primary{background:#2563eb;color:#fff;border-color:#1d4ed8;}
    button.secondary{background:#e5e7eb;color:#111827;border-color:#d1d5db;}
    button.danger{background:#fee2e2;color:#991b1b;border-color:#fecaca;}
    .btn-small{width:auto;padding:.28rem .45rem;font-size:.82rem;border-radius:10px;display:inline-flex;align-items:center;gap:.35rem;}

    .row{display:flex;flex-wrap:wrap;gap:.55rem;}
    .row>div{flex:1 1 45%;}
    @media(max-width:600px){.row>div{flex-basis:100%;}}

    small{color:var(--c-muted);font-size:.74rem;font-style:italic;}
    hr{border:none;border-top:1px solid var(--c-border);margin:.65rem 0;}

    .box{border:1px solid var(--c-border);border-radius:12px;padding:.6rem;background:rgba(255,255,255,.7);margin-top:.55rem;}
    .pill{display:inline-block;background:#f3f4f6;border:1px solid var(--c-border);border-radius:999px;padding:.12rem .5rem;font-size:.72rem;color:#374151;}
    .chk-grid{display:flex;flex-wrap:wrap;gap:.25rem .8rem;}
    .chk-grid label{margin:0;display:flex;align-items:center;gap:.32rem;font-size:.86rem;}

    .inline{display:flex;align-items:center;gap:.45rem;flex-wrap:wrap;margin:.1rem 0 .25rem 0;}
    .muted{color:var(--c-muted);}

    input[type="file"]{display:none;}
    .fileRow{display:flex;gap:.45rem;flex-wrap:wrap;margin:.3rem 0 .2rem 0;}
    .fileRow .fileBtn{
      display:flex;align-items:center;justify-content:center;gap:.32rem;
      padding:.26rem .44rem;border-radius:10px;border:1px solid rgba(0,0,0,.12);
      background:#fff;cursor:pointer;font-size:.82rem;min-width:112px;
      user-select:none;
    }
    .fileRow .fileBtn .bI{font-size:1.0rem;}
    .fileRow .fileBtn.capture{background:#eff6ff;border-color:#bfdbfe;}
    .fileRow .fileBtn.upload{background:#f0fdf4;border-color:#bbf7d0;}

    .secSummary{
      margin-top:.38rem;
      padding:.45rem .55rem;
      border:1px dashed rgba(0,0,0,.18);
      border-radius:10px;
      background:rgba(255,255,255,.55);
      font-size:.80rem;
    }
    .secSummary ul{margin:.22rem 0 0 1rem;padding:0;}
    .secSummary li{margin:.12rem 0;}

    #log{font-size:.74rem;white-space:pre-wrap;max-height:185px;overflow-y:auto;background:var(--bg-log);color:#e5e7eb;padding:.55rem;border-radius:10px;}
    code{background:#f3f4f6;border:1px solid var(--c-border);border-radius:6px;padding:.05rem .22rem;}

    .volRow{display:flex;align-items:center;gap:.45rem;flex-wrap:nowrap}
    .volRow .volDest{flex:1 1 auto;min-width:140px}
    .volRow .pianiWrap{display:flex;align-items:center;gap:.28rem;flex:0 0 auto}
    .iconBtn{width:auto;min-width:0;padding:.22rem .38rem;font-size:.82rem;line-height:1;border-radius:10px}
    .iconBtn.round{border-radius:999px;padding:.18rem .36rem}
    .volRow .volPiani{width:72px;margin:0;padding:.28rem .35rem;font-size:.86rem;text-align:center}
    .volRow input[type="text"]{margin:0}
    .volRow .trashBtn{margin:0}
    .volLbl{font-size:.72rem;color:var(--c-muted);font-style:italic;margin:.12rem 0 .35rem 0}

    .unitaRow{display:flex;align-items:center;gap:.45rem;flex-wrap:nowrap}
    .unitaRow .unitaNome{flex:1 1 auto;min-width:140px;margin:0}
    .pianoWrap{display:flex;align-items:center;gap:.28rem}
    .pianoWrap .pBtn{padding:.22rem .4rem;border-radius:999px}
    .pianoWrap .unitaPiano{width:72px;text-align:center;margin:0}

    .row.inline2{display:flex;gap:.6rem;flex-wrap:nowrap}
    .row.inline2 > div{flex:1 1 50%}
    .row.inline2 select{margin-bottom:0}

    .localeTitleNum{font-weight:700}

    body{padding-bottom:64px;}
    .topbar{
      position:fixed;
      left:0; right:0; bottom:0; top:auto;
      z-index:9999;
      padding:.35rem .4rem;
      border-top:1px solid rgba(0,0,0,.12);
      border-bottom:none;
      background:rgba(255,255,255,.96);
      backdrop-filter:saturate(180%) blur(10px);
      display:flex; align-items:center; justify-content:space-between; gap:.6rem;
    }
    .topbar-title{font-weight:800; letter-spacing:.2px;}
    .topbar-actions{display:flex; flex-wrap:nowrap; gap:.25rem;}

    .topbar .btn-small{
      font-size:.9rem;
      padding:.45rem .5rem;
      min-width:44px;
      min-height:44px;
      border-radius:10px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    @media (max-width:420px){
      .topbar-title{display:none;}
    }

    .sectionTitle,
    .card > h2,
    .card > h3,
    .titleRow{
      text-transform: uppercase;
      font-size: 1.05rem;
      font-weight: 800;
      letter-spacing: .05em;
    }
    label{font-weight:700;font-size:0.95rem;}
    small, .muted{font-size:0.75rem;font-weight:400;}

    .chk-grid label,
    .chk-grid span{
      font-weight:400 !important;
    }

    .uiRow{display:flex;align-items:center;gap:.4rem;flex-wrap:nowrap;margin-top:.45rem}
    .uiRow .uiNum{width:84px;text-align:center;margin:0}
    .uiRow .uiBtn{padding:.22rem .45rem;border-radius:999px}
  </style>
</head>
<body>

  <div class="topbar">
    <div class="topbar-left">
      <span class="topbar-title">Sopralluogo</span>
    </div>
    <div class="topbar-actions">
      <button type="button" class="secondary btn-small" id="tbRefresh">üîÅ</button>
      <button type="button" class="primary btn-small" id="tbShare" title="Condividi (genera ZIP)">üîó</button>
      <button type="button" class="secondary btn-small" id="tbDraftSave" title="Salva bozza">üíæ</button>
      <button type="button" class="secondary btn-small" id="tbDraftLoad" title="Riprendi bozza">‚ôªÔ∏è</button>
      <button type="button" class="secondary btn-small" id="tbDraftClear" title="Pulisci offline">üßπ</button>
    </div>
  </div>

  <h1>App sopralluoghi - base v35</h1>

  <div class="card head">
    <div class="titleRow">
      <strong><span class="icon">üìå</span> PRATICA / SINISTRO</strong>
    </div>

    <div class="row">
      <div>
        <label for="praticaId">Pratica</label>
        <input type="text" id="praticaId" placeholder="Es. 2025-AC-00423" />
      </div>
      <div>
        <label for="assicurato">Assicurato</label>
        <input type="text" id="assicurato" placeholder="Es. Rossi Mario / Condominio ..." />
      </div>
    </div>

    <label for="refTag">Riferimento tag</label>
    <input type="text" id="refTag" placeholder="Es. TAG-CRM / codice interno" />

    <div class="row" style="align-items:flex-end;">
      <div style="flex:1 1 70%;">
        <label for="indirizzo">Indirizzo (GPS -> editabile)</label>
        <input type="text" id="indirizzo" placeholder="Es. Via ..., n. ..., Comune" />
        <small>Se GPS disponibile, precompila con coordinate.</small>
      </div>
      <div style="flex:1 1 30%;">
        <button type="button" class="secondary btn-small" id="gpsBtn">üìç Rileva posizione</button>
      </div>
    </div>

    <small>Apri la pagina con <code>?ref=...</code> per compilare automaticamente Pratica.</small>
  </div>

  <div class="card risk">
    <div class="titleRow">
      <strong><span class="icon">üè¢</span> Panoramica del rischio</strong>
    </div>

    <label>Tipologia fabbricato</label>
    <div class="chk-grid">
      <label><input type="radio" name="tipologia" value="Condominio" /> Condominio</label>
      <label><input type="radio" name="tipologia" value="Appartamento" /> Appartamento</label>
      <label><input type="radio" name="tipologia" value="Villa" /> Villa</label>
      <label><input type="radio" name="tipologia" value="Uffici" /> Uffici</label>
      <label><input type="radio" name="tipologia" value="Capannone industriale" /> Capannone industriale</label>
    </div>

    <label for="tipologiaAltro">Altro (testo libero)</label>
    <input type="text" id="tipologiaAltro" placeholder="Es. negozio, laboratorio, scuola..." />

    <div class="row uiRow">
      <div style="flex:1 1 auto;">
        <label for="uiCount">Numero U.I.</label>
        <small><i>Campo informativo (non vincolante).</i></small>
      </div>
      <button type="button" class="secondary btn-small uiBtn" id="uiMinus">-</button>
      <input type="number" id="uiCount" class="uiNum" value="1" min="0" step="1" />
      <button type="button" class="secondary btn-small uiBtn" id="uiPlus">+</button>
    </div>

    <hr />

    <strong><span class="icon">üß±</span> Volumi</strong>
    <small>Solo Destinazione e N. piani. Default: 2 blocchi (2¬∞ = Interrato e pertinenze, -1).</small>
    <div id="volumiContainer"></div>
    <div class="inline" style="margin-top:.45rem;">
      <button type="button" class="secondary btn-small" id="addVolumeBtn">+ Aggiungi volume</button>
    </div>

    <hr />

    <strong><span class="icon">üñºÔ∏è</span> Foto panoramica del rischio</strong>
    <small>Salvate in cartella unica <b>FOTO</b> con nome <code>-PANORAMICA-###</code>.</small>

    <div class="fileRow">
      <label class="fileBtn capture" for="photoRiskCapture"><span class="bI">üì∑</span> Scatta</label>
      <input type="file" id="photoRiskCapture" accept="image/*" capture="environment" multiple />

      <label class="fileBtn upload" for="photoRiskUpload"><span class="bI">üñºÔ∏è</span> Carica</label>
      <input type="file" id="photoRiskUpload" accept="image/*" multiple />
    </div>

    <div class="secSummary" id="secSum_pan">
      <div><b>Riepilogo sezione</b> <span class="muted">(Panoramica)</span></div>
      <div class="muted">Nessuna foto.</div>
    </div>
  </div>

  <div class="card unita">
    <div class="titleRow">
      <strong><span class="icon">üè†</span> UNITA</strong>
    </div>
    <small>Dentro aggiungi i Locali. Ogni locale ha foto Scatta/Carica e riepilogo sezione.</small>
    <div id="unitaContainer"></div>
    <div class="inline" style="justify-content:flex-end;margin-top:.5rem;">
      <button type="button" class="secondary btn-small" id="addUnitaBtn">+ Aggiungi unita</button>
    </div>
  </div>

  <div class="card summary">
    <div class="titleRow">
      <strong><span class="icon">üßæ</span> Riepilogo finale foto</strong>
      <button type="button" class="secondary btn-small" id="refreshNamesBtn">üîÅ Aggiorna nomi foto</button>
    </div>
    <small>Se modifichi Nome/Piano/Locale/Danno, usa ‚ÄúAggiorna nomi foto‚Äù per riallineare l'elenco (rinomina logica, non il file sul telefono).</small>
    <div class="secSummary" id="finalList">
      <div class="muted">Nessuna foto.</div>
    </div>
  </div>

  <div class="card notes">
    <div class="titleRow">
      <strong><span class="icon">üìù</span> Note generali</strong>
    </div>
    <textarea id="noteGenerali" placeholder="Es. accesso regolare, presenti amministratore e inquilino..."></textarea>
  </div>

  <div class="card actions">
    <div class="titleRow">
      <strong><span class="icon">üì¶</span> Output</strong>
    </div>
    <div class="row">
      <div><button class="primary" type="button" id="generateZipBtn">Genera ZIP sopralluogo</button></div>
      <div><button class="secondary" type="button" id="resetBtn">Svuota dati</button></div>
    </div>
    <small>ZIP contiene: cartella <b>FOTO</b> + report TXT + report JSON.</small>
  </div>

  <div class="card log">
    <div class="titleRow">
      <strong><span class="icon">üß™</span> Log</strong>
    </div>
    <pre id="log"></pre>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script>
    // -------------------------
    // UTIL
    // -------------------------
    function uid(){
      if(window.crypto && crypto.randomUUID) return crypto.randomUUID();
      return "id_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
    }
    function log(msg){
      const el=document.getElementById("log");
      const ts=new Date().toISOString().substring(11,19);
      el.textContent += "["+ts+"] "+msg+"\n";
      el.scrollTop = el.scrollHeight;
    }
    function sanitize(s){ return (s||"").toString().replace(/[^a-zA-Z0-9_\-]/g,"_"); }

    // -------------------------
    // DATASTORE
    // -------------------------
    const dataStore = { photos: [], noteGenerali: "" };
    let gpsData = null;

    // -------------------------
    // GPS + URL REF
    // -------------------------
    function acquireGPS(){
      if(!navigator.geolocation){ log("GPS non supportato"); return; }
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          gpsData={lat:pos.coords.latitude,lng:pos.coords.longitude,accuracy:pos.coords.accuracy,timestamp:new Date().toISOString()};
          log("GPS acquisito: "+gpsData.lat.toFixed(6)+", "+gpsData.lng.toFixed(6));
          const indirizzoEl=document.getElementById("indirizzo");
          if(!indirizzoEl.value) indirizzoEl.value="Coord: "+gpsData.lat.toFixed(6)+", "+gpsData.lng.toFixed(6);
        },
        (err)=>log("GPS non disponibile: "+err.message)
      );
    }
    function readRefFromUrl(){
      const params=new URLSearchParams(window.location.search);
      const ref=params.get("ref")||params.get("prot")||params.get("id")||"";
      if(ref){
        document.getElementById("praticaId").value=ref;
        log("Pratica da URL: "+ref);
      }
    }

    // -------------------------
    // VOLUMI
    // -------------------------
    function createVolumeCard(destDefault="Residenziale", pianiDefault=1){
      const wrap=document.createElement("div");
      wrap.className="box";
      wrap.innerHTML = `
        <div class="volLbl">Destinazione + N. piani (accetta negativi)</div>
        <div class="volRow">
          <input type="text" class="volDest" value="${destDefault}" placeholder="Destinazione" />
          <div class="pianiWrap">
            <button type="button" class="secondary btn-small iconBtn round volMinus">-</button>
            <input type="number" class="volPiani" value="${pianiDefault}" step="1">
            <button type="button" class="secondary btn-small iconBtn round volPlus">+</button>
          </div>
          <button type="button" class="danger btn-small iconBtn trashBtn volRemove" title="Elimina volume">üóëÔ∏è</button>
        </div>
      `;
      wrap.querySelector(".volMinus").addEventListener("click",()=>{
        const el=wrap.querySelector(".volPiani");
        el.value = (parseInt(el.value||"0",10)-1);
      });
      wrap.querySelector(".volPlus").addEventListener("click",()=>{
        const el=wrap.querySelector(".volPiani");
        el.value = (parseInt(el.value||"0",10)+1);
      });
      wrap.querySelector(".volRemove").addEventListener("click",()=>wrap.remove());
      return wrap;
    }

    // -------------------------
    // UNIT√Ä + LOCALI
    // -------------------------
    const LOCAL_PRESETS=["Ingresso","Soggiorno","Cucina","Bagno","Camera","Disimpegno","Corridoio","Balcone","Terrazzo","Tetto","Facciata","Cantina","Box"];
    const DANNO_PRESETS=["danni AC","RRG","cristallo","guasti ladri"];

    function createLocaleCard(){
      const localeUid = uid();
      const capId = "cap_" + localeUid;
      const upId  = "up_" + localeUid;

      const wrap=document.createElement("div");
      wrap.className="box";
      wrap.dataset.localeUid = localeUid;

      wrap.innerHTML = `
        <div class="titleRow" style="margin-bottom:.2rem;">
          <div class="inline" style="gap:.45rem;margin:0;">
            <span class="pill">Locale</span> <span class="localeTitleNum">#<span class="localeIdx">1</span></span>
            <span class="muted"> e foto</span>
          </div>
          <button type="button" class="danger btn-small removeLocaleBtn">üóëÔ∏è Elimina</button>
        </div>

        <label>Locale</label>
        <div class="chk-grid localeChecks"></div>
        <input type="text" class="localeAltro" placeholder="Altro locale (testo libero)" />

        <label>Tipi di danno</label>
        <div class="chk-grid dannoChecks"></div>
        <input type="text" class="dannoAltro" placeholder="Altro tipo danno (testo libero)" />

        <label>Note locale</label>
        <textarea class="noteLocale" placeholder="Note libere sul locale/danno"></textarea>

        <div class="fileRow">
          <label class="fileBtn capture" for="${capId}"><span class="bI">üì∑</span> Scatta</label>
          <input type="file" id="${capId}" class="photoCaptureLocale" accept="image/*" capture="environment" multiple />

          <label class="fileBtn upload" for="${upId}"><span class="bI">üñºÔ∏è</span> Carica</label>
          <input type="file" id="${upId}" class="photoUploadLocale" accept="image/*" multiple />
        </div>

        <div class="secSummary" id="sum_${localeUid}">
          <div><b>Riepilogo sezione</b> <span class="muted">(Locale)</span></div>
          <div class="muted">Nessuna foto.</div>
        </div>
      `;

      const localeChecks=wrap.querySelector(".localeChecks");
      LOCAL_PRESETS.forEach(v=>{
        const lab=document.createElement("label");
        lab.innerHTML = `<input type="checkbox" value="${v}"> ${v}`;
        localeChecks.appendChild(lab);
      });

      const dannoChecks=wrap.querySelector(".dannoChecks");
      DANNO_PRESETS.forEach(v=>{
        const lab=document.createElement("label");
        lab.innerHTML = `<input type="checkbox" value="${v}"> ${v}`;
        dannoChecks.appendChild(lab);
      });

      wrap.querySelector(".removeLocaleBtn").addEventListener("click",()=>{
        const u=wrap.closest("[data-unita-uid]");
        wrap.remove();
        renumberLocales(u);
        refreshAllSummaries();
      });

      return wrap;
    }

    function createUnitaCard(){
      const unitaUid = uid();

      const wrap=document.createElement("div");
      wrap.className="box";
      wrap.dataset.unitaUid = unitaUid;

      wrap.innerHTML = `
        <div class="titleRow">
          <div class="inline" style="gap:.45rem;margin:0;">
            <span class="pill">Unita</span>
            <span class="muted"></span>
          </div>
          <button type="button" class="danger btn-small removeUnitaBtn">üóëÔ∏è Elimina</button>
        </div>

        <div class="unitaRow">
          <input type="text" class="unitaNome" placeholder="Es. Rossi / Interno 5" />
          <div class="pianoWrap">
            <button type="button" class="secondary btn-small pBtn pianoMinus">-</button>
            <input type="number" class="unitaPiano" placeholder="P" step="1" />
            <button type="button" class="secondary btn-small pBtn pianoPlus">+</button>
          </div>
        </div>

        <div class="localiContainer"></div>

        <div class="inline" style="justify-content:flex-end;margin-top:.45rem;">
          <button type="button" class="secondary btn-small addLocaleBtn">+ Aggiungi locale</button>
        </div>
      `;

      const localiContainer=wrap.querySelector(".localiContainer");
      const pianoEl = wrap.querySelector('.unitaPiano');

      wrap.querySelector('.pianoMinus').addEventListener('click',()=>{
        pianoEl.value = (parseInt(pianoEl.value||'0',10)-1);
      });
      wrap.querySelector('.pianoPlus').addEventListener('click',()=>{
        pianoEl.value = (parseInt(pianoEl.value||'0',10)+1);
      });

      wrap.querySelector(".addLocaleBtn").addEventListener("click",()=>{
        const loc=createLocaleCard();
        localiContainer.appendChild(loc);
        bindLocalePhotoHandlers(wrap, loc);
        renumberLocales(wrap);
        refreshAllSummaries();
      });

      const loc0=createLocaleCard();
      localiContainer.appendChild(loc0);
      bindLocalePhotoHandlers(wrap, loc0);
      renumberLocales(wrap);

      wrap.querySelector(".removeUnitaBtn").addEventListener("click",()=>{
        wrap.remove();
        refreshAllSummaries();
      });

      return wrap;
    }

    // -------------------------
    // FOTO + RIEPILOGHI
    // -------------------------
    function sectionKey(meta){
      if(meta.type==="PANORAMICA") return "PANORAMICA";
      return meta.localeUid ? ("LOCALE:" + meta.localeUid) : "LOCALE:ND";
    }

    function updateSectionSummary(secKey){
      if(secKey==="PANORAMICA"){
        const box=document.getElementById("secSum_pan");
        const items=dataStore.photos.filter(p=>sectionKey(p.meta)===secKey);
        if(!items.length){
          box.innerHTML = `<div><b>Riepilogo sezione</b> <span class="muted">(Panoramica)</span></div><div class="muted">Nessuna foto.</div>`;
          return;
        }
        const names = items.map(p=>({name:(p.previewName||p.file.name)}));
        box.innerHTML = `<div><b>Riepilogo sezione</b> <span class="muted">(Panoramica)</span> - ${items.length} foto</div><ul>${names.map(n=>`<li>${n.name}</li>`).join("")}</ul>`;
        return;
      }

      if(secKey.startsWith("LOCALE:")){
        const uid=secKey.split(":")[1];
        const box=document.getElementById("sum_"+uid);
        if(!box) return;
        const items=dataStore.photos.filter(p=>sectionKey(p.meta)===secKey);
        if(!items.length){
          box.innerHTML = `<div><b>Riepilogo sezione</b> <span class="muted">(Locale)</span></div><div class="muted">Nessuna foto.</div>`;
          return;
        }
        const names=items.map(p=>({name:(p.previewName||p.file.name)}));
        box.innerHTML = `<div><b>Riepilogo sezione</b> <span class="muted">(Locale)</span> - ${items.length} foto</div><ul>${names.map(n=>`<li>${n.name}</li>`).join("")}</ul>`;
      }
    }

    function updateFinalSummary(){
      const box=document.getElementById("finalList");
      if(!dataStore.photos.length){
        box.innerHTML = `<div class="muted">Nessuna foto.</div>`;
        return;
      }
      const items = dataStore.photos.map((p,i)=>{
        const sec = (p.meta.type==="PANORAMICA") ? "PANORAMICA" : `UNITA ${p.meta.unitaPiano||""} ${p.meta.unitaNome||""}`;
        return { idx:i+1, sec, name: p.previewName || p.file.name };
      });

      box.innerHTML = `
        <div><b>Totale</b>: ${items.length} foto</div>
        <ul>
          ${items.map(x=>`<li>${x.idx}. <span class="muted">[${x.sec}]</span> ${x.name}</li>`).join("")}
        </ul>
      `;
    }

    function refreshAllSummaries(){
      updateSectionSummary("PANORAMICA");
      const localeIds = Array.from(document.querySelectorAll("[id^='sum_']")).map(el=>el.id.replace("sum_",""));
      for(const uid of localeIds){
        updateSectionSummary("LOCALE:"+uid);
      }
      updateFinalSummary();
    }

    async function addPhotos(files, meta){
      if(!files || !files.length) return;
      for(const file of Array.from(files)){
        const id = uid();
        const item = { id, file, meta:{...meta}, previewName: file.name };
        dataStore.photos.push(item);
        log("Foto aggiunta: " + file.name);
      }
      refreshAllSummaries();
    }

    function bindLocalePhotoHandlers(unitaEl, localeEl){
      const cap=localeEl.querySelector(".photoCaptureLocale");
      const up=localeEl.querySelector(".photoUploadLocale");
      if(cap.dataset.bound==="1") return;

      const handler = async (files)=>{
        const unitaNome = (unitaEl.querySelector(".unitaNome")?.value||"").trim();
        const unitaPiano = (unitaEl.querySelector(".unitaPiano")?.value||"").trim();

        const localeTags = Array.from(localeEl.querySelectorAll(".localeChecks input[type='checkbox']:checked")).map(x=>x.value);
        const localeAltro = (localeEl.querySelector(".localeAltro")?.value||"").trim();
        const danniTags = Array.from(localeEl.querySelectorAll(".dannoChecks input[type='checkbox']:checked")).map(x=>x.value);
        const danniAltro = (localeEl.querySelector(".dannoAltro")?.value||"").trim();
        const note = (localeEl.querySelector(".noteLocale")?.value||"").trim();

        const meta = {
          type:"LOCALE",
          unitaNome, unitaPiano,
          localeTags, localeAltro,
          danniTags, danniAltro,
          note,
          localeUid: localeEl.dataset.localeUid
        };
        await addPhotos(files, meta);
      };

      cap.addEventListener("change", async (e)=>{ await handler(e.target.files); e.target.value=""; });
      up.addEventListener("change", async (e)=>{ await handler(e.target.files); e.target.value=""; });

      cap.dataset.bound="1";
      up.dataset.bound="1";
    }

    function renumberLocales(unitEl){
      if(!unitEl) return;
      const locales = Array.from(unitEl.querySelectorAll(".localiContainer .box[data-locale-uid]"));
      locales.forEach((loc, i)=>{
        const idxEl = loc.querySelector(".localeIdx");
        if(idxEl) idxEl.textContent = String(i+1);
      });
    }

    // -------------------------
    // NOMI FILE (previewName)
    // -------------------------
    function recomputePreviewNames(){
      const counters = {};
      for(const item of dataStore.photos){
        const original=item.file.name||"";
        const ext=original.includes(".") ? original.split(".").pop() : "jpg";

        if(item.meta.type==="PANORAMICA"){
          const key="PANORAMICA";
          counters[key]=(counters[key]||0)+1;
          const idx=String(counters[key]).padStart(3,"0");
          item.previewName = "-PANORAMICA-" + idx + "." + ext;
          continue;
        }

        const pianoKey = sanitize(item.meta.unitaPiano || "P_ND");
        let rawNomeKey = (item.meta.unitaNome || "NOME");
        rawNomeKey = rawNomeKey.replace(/^UI[_\- ]*/i, "");
        const nomeKey = sanitize(rawNomeKey);

        const locLabelKey = (item.meta.localeTags && item.meta.localeTags.length) ? item.meta.localeTags.join("+") : (item.meta.localeAltro || "LOCALE");
        const localeKey = sanitize(locLabelKey);

        const dannoLabelKey = (item.meta.danniTags && item.meta.danniTags.length) ? item.meta.danniTags.join("+") : (item.meta.danniAltro || "DANNO");
        const dannoKey = sanitize(dannoLabelKey);

        const key = [pianoKey,nomeKey,localeKey,dannoKey].join("_");
        counters[key]=(counters[key]||0)+1;
        const idx=String(counters[key]).padStart(3,"0");
        item.previewName = "-" + pianoKey + "_" + nomeKey + "_" + localeKey + "_" + dannoKey + "-" + idx + "." + ext;
      }

      refreshAllSummaries();
      log("Nomi foto aggiornati (preview).");
    }

    // -------------------------
    // ZIP (UNA SOLA VERSIONE)
    // -------------------------
    async function buildZipPackage(){
      if(!dataStore.photos.length) throw new Error("Non ci sono foto da salvare.");

      recomputePreviewNames();

      const zip = new JSZip();
      const folder = zip.folder("FOTO");

      for(const item of dataStore.photos){
        const filename = item.previewName || item.file.name;
        folder.file(filename, await item.file.arrayBuffer());
      }

      // report JSON
      const payload = {
        pratica: (document.getElementById("praticaId")?.value||"").trim(),
        assicurato: (document.getElementById("assicurato")?.value||"").trim(),
        refTag: (document.getElementById("refTag")?.value||"").trim(),
        indirizzo: (document.getElementById("indirizzo")?.value||"").trim(),
        gps: gpsData,
        totalFoto: dataStore.photos.length,
        foto: dataStore.photos.map(p=>({
          name: p.previewName || p.file.name,
          meta: p.meta
        })),
        noteGenerali: (document.getElementById("noteGenerali")?.value||"").trim(),
        createdAt: new Date().toISOString()
      };
      zip.file("report.json", JSON.stringify(payload, null, 2));

      // report TXT
      const txt =
        "Trasmissione sopralluogo - report sintetico\n\n" +
        "Pratica/Sinistro: " + (payload.pratica||"-") + "\n" +
        "Assicurato: " + (payload.assicurato||"-") + "\n" +
        "Riferimento tag: " + (payload.refTag||"-") + "\n" +
        "Indirizzo: " + (payload.indirizzo||"-") + "\n" +
        "Foto (ZIP): " + payload.totalFoto + "\n\n" +
        "NOTE:\n" + (payload.noteGenerali||"-") + "\n";
      zip.file("report.txt", txt);

      const now = new Date();
      const baseRef = sanitize(payload.pratica || payload.refTag || "sopralluogo");
      const filename = baseRef + "_" + now.toISOString().replace(/[:.]/g,"-") + ".zip";

      const blob = await zip.generateAsync({type:"blob"});
      return { blob, filename };
    }

    async function downloadZip(){
      const { blob, filename } = await buildZipPackage();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      log("ZIP scaricato: " + filename);
    }

    async function shareZipPackage(){
      const { blob, filename } = await buildZipPackage();
      const file = new File([blob], filename, {type:"application/zip"});

      const isSecure = (window.isSecureContext || location.hostname === "127.0.0.1" || location.hostname === "localhost");
      const canShareFiles = !!(isSecure && navigator.share && navigator.canShare && navigator.canShare({ files:[file] }));

      if(canShareFiles){
        try{
          await navigator.share({ title: filename, files:[file] });
          log("üîó Share sheet aperto (scegli Email/Cloud).");
          return;
        }catch(e){
          log("‚ö†Ô∏è Share annullato/non disponibile: fallback download.");
        }
      }else{
        log("‚ÑπÔ∏è Share sheet file non supportato qui: fallback download.");
      }

      // fallback download
      await downloadZip();

      // fallback mailto testo pronto
      const pratica = (document.getElementById("praticaId")?.value||"").trim() || "-";
      const assicurato = (document.getElementById("assicurato")?.value||"").trim() || "-";
      const refTag = (document.getElementById("refTag")?.value||"").trim() || "-";
      const indirizzo = (document.getElementById("indirizzo")?.value||"").trim() || "-";
      const nfoto = dataStore.photos.length;

      const subject = encodeURIComponent("Sopralluogo - " + pratica);
      const body = encodeURIComponent(
        "Trasmissione sopralluogo - report sintetico\n\n" +
        "Pratica/Sinistro: " + pratica + "\n" +
        "Assicurato: " + assicurato + "\n" +
        "Riferimento tag: " + refTag + "\n" +
        "Indirizzo: " + indirizzo + "\n" +
        "Foto (ZIP): " + nfoto + "\n\n" +
        "NOTE:\n- \n\n" +
        "Allega il file ZIP appena scaricato:\n" + filename
      );

      window.location.href = "mailto:?subject=" + subject + "&body=" + body;
      log("üìß Mail aperta (allega manualmente lo ZIP scaricato).");
    }

    // -------------------------
    // BOZZA (semplificata: solo campi, NON foto)
    // -------------------------
    function draftKey(){ return "sopralluoghi_draft_v35"; }

    function saveDraft(){
      const draft = {
        praticaId: (document.getElementById("praticaId")?.value||"").trim(),
        assicurato: (document.getElementById("assicurato")?.value||"").trim(),
        refTag: (document.getElementById("refTag")?.value||"").trim(),
        indirizzo: (document.getElementById("indirizzo")?.value||"").trim(),
        noteGenerali: (document.getElementById("noteGenerali")?.value||"").trim(),
        savedAt: new Date().toISOString()
      };
      localStorage.setItem(draftKey(), JSON.stringify(draft));
      log("üíæ Bozza salvata (localStorage).");
    }

    function loadDraft(){
      const raw = localStorage.getItem(draftKey());
      if(!raw){ log("Nessuna bozza trovata."); return; }
      const d = JSON.parse(raw);
      if(document.getElementById("praticaId")) document.getElementById("praticaId").value = d.praticaId||"";
      if(document.getElementById("assicurato")) document.getElementById("assicurato").value = d.assicurato||"";
      if(document.getElementById("refTag")) document.getElementById("refTag").value = d.refTag||"";
      if(document.getElementById("indirizzo")) document.getElementById("indirizzo").value = d.indirizzo||"";
      if(document.getElementById("noteGenerali")) document.getElementById("noteGenerali").value = d.noteGenerali||"";
      log("‚ôªÔ∏è Bozza ripristinata.");
    }

    function clearDraft(){
      localStorage.removeItem(draftKey());
      log("üßπ Bozza rimossa.");
    }

    // -------------------------
    // INIT + HANDLER
    // -------------------------
    readRefFromUrl();

    document.getElementById('gpsBtn')?.addEventListener('click', acquireGPS);

    // UI count
    const uiCountEl = document.getElementById('uiCount');
    document.getElementById('uiMinus')?.addEventListener('click', ()=>{
      const v = parseInt(uiCountEl.value||"0",10);
      uiCountEl.value = String(Math.max(0, v-1));
    });
    document.getElementById('uiPlus')?.addEventListener('click', ()=>{
      const v = parseInt(uiCountEl.value||"0",10);
      uiCountEl.value = String(v+1);
    });

    // Volumi default
    const volCont=document.getElementById("volumiContainer");
    volCont.appendChild(createVolumeCard("Residenziale", 1));
    volCont.appendChild(createVolumeCard("Interrato e pertinenze", -1));
    document.getElementById("addVolumeBtn")?.addEventListener("click",()=>volCont.appendChild(createVolumeCard()));

    // Unit√† default
    const unitaCont=document.getElementById("unitaContainer");
    const u0=createUnitaCard();
    unitaCont.appendChild(u0);

    document.getElementById("addUnitaBtn")?.addEventListener("click",()=>{
      const u=createUnitaCard();
      unitaCont.appendChild(u);
      refreshAllSummaries();
    });

    // Pano photos
    async function addPano(files){
      if(!files||!files.length) return;
      await addPhotos(files, { type:"PANORAMICA" });
    }
    document.getElementById("photoRiskCapture")?.addEventListener("change", async (e)=>{ await addPano(e.target.files); e.target.value=""; });
    document.getElementById("photoRiskUpload")?.addEventListener("change", async (e)=>{ await addPano(e.target.files); e.target.value=""; });

    document.getElementById("noteGenerali")?.addEventListener("input",(e)=>dataStore.noteGenerali=e.target.value);

    document.getElementById("resetBtn")?.addEventListener("click",()=>{
      if(!confirm("Sicuro di svuotare foto e note?")) return;
      dataStore.photos=[];
      document.getElementById("noteGenerali").value="";
      document.getElementById("log").textContent="";
      refreshAllSummaries();
      log("Dati azzerati.");
    });

    document.getElementById("refreshNamesBtn")?.addEventListener("click", ()=>{
      if(!dataStore.photos.length){ alert("Nessuna foto da aggiornare."); return; }
      recomputePreviewNames();
    });

    document.getElementById("generateZipBtn")?.addEventListener("click", async ()=>{
      try{ await downloadZip(); }
      catch(e){ alert(e?.message || "Errore ZIP."); }
    });

    // Bottom bar
    document.getElementById('tbRefresh')?.addEventListener('click', ()=> document.getElementById('refreshNamesBtn')?.click());
    document.getElementById('tbShare')?.addEventListener('click', async ()=>{
      try{ await shareZipPackage(); } catch(e){ alert(e?.message || "Errore condivisione."); }
    });
    document.getElementById('tbDraftSave')?.addEventListener('click', saveDraft);
    document.getElementById('tbDraftLoad')?.addEventListener('click', loadDraft);
    document.getElementById('tbDraftClear')?.addEventListener('click', ()=>{
      if(confirm("Rimuovere bozza salvata?")) clearDraft();
    });

    refreshAllSummaries();
  </script>
</body>
</html>