<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>App sopralluoghi</title>
  <style>
    :root{
      --fg:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --card:#ffffff;

      --bg-head:#e3edff;
      --bg-risk:#dff7f2;
      --bg-unita:#e8f1ff;
      --bg-summary:#f0f0f0;
      --bg-notes:#fff7ed;
      --bg-actions:#f1f5f9;

      --btn:#111827;
      --btn2:#374151;
      --danger:#b91c1c;
      --ok:#047857;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      color:var(--fg);
      background:#fafafa;
      padding:12px 12px 84px;
    }
    h1{
      margin:6px 0 12px;
      font-size:1.25rem;
      letter-spacing:.02em;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      margin:10px 0;
      box-shadow:0 1px 0 rgba(0,0,0,.03);
    }
    .head{background:var(--bg-head)}
    .risk{background:var(--bg-risk)}
    .unita{background:var(--bg-unita)}
    .summary{background:var(--bg-summary)}
    .notes{background:var(--bg-notes)}
    .actions{background:var(--bg-actions)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row.nowrap{flex-wrap:nowrap}
    .col{flex:1 1 220px}
    label{display:block;font-weight:700;margin:6px 0 4px}
    .hint{font-style:italic;color:var(--muted);font-size:.92em;margin:6px 0}
    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 10px;
      font-size:14px;
      background:#fff;
      color:var(--fg);
      outline:none;
    }
    textarea{min-height:76px;resize:vertical}
    .mini{font-size:.92em;color:var(--muted);font-weight:500}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border:1px solid var(--border);
      border-radius:999px;background:#fff;font-size:13px;
    }
    .opts{display:flex;flex-direction:column;gap:6px;margin:8px 0}
    .opt{display:flex;gap:10px;align-items:center}
    .opt input{transform:scale(1.05)}
    .btn{
      border:0;border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      color:#fff;
      background:var(--btn);
      cursor:pointer;
    }
    .btn.secondary{background:var(--btn2)}
    .btn.danger{background:var(--danger)}
    .btn.ok{background:var(--ok)}
    .btn.small{padding:8px 10px;font-size:13px;border-radius:10px}
    .iconbtn{
      width:38px;height:38px;border-radius:10px;border:1px solid var(--border);
      background:#fff;display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer;
    }
    .iconbtn.danger{border-color:#fecaca;background:#fff1f2}
    .iconbtn svg{width:18px;height:18px}
    .inline{
      display:flex;gap:8px;align-items:center;flex-wrap:nowrap;
    }
    .inline > *{flex:1}
    .inline .fixed{flex:0 0 auto}
    .counter{
      display:flex;gap:6px;align-items:center;justify-content:flex-start;
    }
    .counter input{max-width:84px;text-align:center}
    .counter .btn.small{min-width:40px}
    .photo-tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .photo-list{margin:10px 0 0;padding:0;list-style:none}
    .photo-list li{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:8px 10px;margin:6px 0;background:#fff;border:1px solid var(--border);
      border-radius:12px;
    }
    .photo-name{font-size:13px;word-break:break-word}
    .photo-actions{display:flex;gap:6px;align-items:center}
    .divider{height:1px;background:rgba(0,0,0,.06);margin:10px 0}
    details>summary{cursor:pointer;font-weight:800}
    summary::-webkit-details-marker{display:none}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      font-size:12px;padding:4px 10px;border-radius:999px;
      background:#fff;border:1px solid var(--border);color:var(--muted);
    }

    /* Bottom bar */
    .bottombar{
      position:fixed;
      left:12px; right:12px; bottom:12px;
      background:#ffffff;
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      z-index:999;
      box-shadow:0 8px 22px rgba(0,0,0,.08);
    }
    .bottombar .btn{
      flex:1;
      padding:12px 10px;
      font-weight:700;
      border-radius:14px;
      display:flex;align-items:center;justify-content:center;gap:8px;
      white-space:nowrap;
    }
    .toast{
      position:fixed;left:50%;bottom:92px;transform:translateX(-50%);
      background:#111827;color:#fff;padding:10px 12px;border-radius:12px;
      font-size:13px;opacity:0;pointer-events:none;transition:.2s;
      max-width:min(92vw,520px);
      text-align:center;
    }
    .toast.show{opacity:1}
    .muted{color:var(--muted)}
  </style>
</head>
<body>

  <h1>APP SOPRALLUOGHI</h1>

  <!-- PRATICA / SINISTRO -->
  <section class="card head" id="praticaCard">
    <div class="row">
      <div class="col">
        <label>PRATICA/SINISTRO</label>
        <div class="inline">
          <input id="praticaId" type="text" placeholder="Es. 2025-AC-00423" />
          <button class="btn small secondary fixed" type="button" onclick="pasteTo('praticaId')">üìã Incolla</button>
        </div>
      </div>
      <div class="col">
        <label>ASSICURATO</label>
        <div class="inline">
          <input id="assicurato" type="text" placeholder="Es. Rossi Mario" />
          <button class="btn small secondary fixed" type="button" onclick="pasteTo('assicurato')">üìã Incolla</button>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>RIFERIMENTO TAG</label>
        <input id="tagRef" type="text" placeholder="Es. Condominio / Interno 4 / ecc." />
      </div>

      <div class="col">
        <label>INDIRIZZO (GPS -> EDITABILE)</label>
        <div class="inline">
          <input id="indirizzo" type="text" placeholder="Via ..., n. ..., Comune" />
          <button class="btn small secondary fixed" type="button" onclick="getLocation()">üìç Posizione</button>
        </div>
        <div class="mini muted" id="gpsInfo"></div>
      </div>
    </div>
  </section>

  <!-- PANORAMICA RISCHIO + FOTO -->
  <section class="card risk" id="riskCard">
    <details open>
      <summary>PANORAMICA DEL RISCHIO</summary>

      <div class="divider"></div>

      <label>TIPOLOGIA DI FABBRICATO</label>
      <div class="opts" id="tipologiaOpts">
        <label class="opt"><input type="radio" name="tipologia" value="Condominio"> Condominio</label>
        <label class="opt"><input type="radio" name="tipologia" value="Appartamento"> Appartamento</label>
        <label class="opt"><input type="radio" name="tipologia" value="Villa"> Villa</label>
        <label class="opt"><input type="radio" name="tipologia" value="Uffici"> Uffici</label>
        <label class="opt"><input type="radio" name="tipologia" value="Capannone industriale"> Capannone industriale</label>
      </div>
      <div class="row">
        <div class="col">
          <label class="mini">ALTRO (LIBERO)</label>
          <input id="tipologiaAltro" type="text" placeholder="Es. Negozio / Laboratorio / ecc." />
        </div>
        <div class="col">
          <label>NUMERO U.I.</label>
          <div class="counter">
            <button class="btn small secondary" type="button" onclick="stepNumber('numUI',-1)">-</button>
            <input id="numUI" type="number" value="0" />
            <button class="btn small secondary" type="button" onclick="stepNumber('numUI',1)">+</button>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div class="col">
          <label>DESTINAZIONE (1)</label>
          <input id="dest1" type="text" value="Residenziale" />
        </div>
        <div class="col">
          <label>N. PIANI (1)</label>
          <div class="counter">
            <button class="btn small secondary" type="button" onclick="stepNumber('piani1',-1)">-</button>
            <input id="piani1" type="number" value="0" />
            <button class="btn small secondary" type="button" onclick="stepNumber('piani1',1)">+</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>DESTINAZIONE (2)</label>
          <input id="dest2" type="text" value="Interrato e pertinenze" />
        </div>
        <div class="col">
          <label>N. PIANI (2)</label>
          <div class="counter">
            <button class="btn small secondary" type="button" onclick="stepNumber('piani2',-1)">-</button>
            <input id="piani2" type="number" value="0" />
            <button class="btn small secondary" type="button" onclick="stepNumber('piani2',1)">+</button>
          </div>
        </div>
      </div>

      <div class="hint">*I campi non sono vincolanti. Se non li compili, non blocca nulla.*</div>

      <div class="divider"></div>

      <label>CARATTERISTICHE COSTRUTTIVE (SELEZIONE MULTIPLA)</label>
      <div class="opts" id="costrOpts">
        <label class="opt"><input type="checkbox" value="Struttura verticale"> Struttura verticale</label>
        <label class="opt"><input type="checkbox" value="Struttura orizzontale"> Struttura orizzontale</label>
        <label class="opt"><input type="checkbox" value="Facciate"> Facciate</label>
        <label class="opt"><input type="checkbox" value="Copertura"> Copertura</label>
      </div>

      <div class="row">
        <div class="col">
          <label>FINITURE</label>
          <select id="finiture">
            <option value="">-</option>
            <option>Scarse</option>
            <option>Medie</option>
            <option>Alte</option>
          </select>
        </div>
        <div class="col">
          <label>CANTIERE</label>
          <select id="cantiere">
            <option value="">-</option>
            <option>Normale</option>
            <option>Penalizzante</option>
          </select>
        </div>
        <div class="col">
          <label class="opt" style="font-weight:700;display:flex;gap:10px;align-items:center;margin-top:22px">
            <input id="ascensore" type="checkbox"> Ascensore
          </label>
        </div>
        <div class="col">
          <label class="opt" style="font-weight:700;display:flex;gap:10px;align-items:center;margin-top:22px">
            <input id="fv" type="checkbox"> Pannelli FV
          </label>
        </div>
      </div>

      <div class="divider"></div>

      <label>FOTO PANORAMICA</label>
      <div class="photo-tools">
        <button class="btn small secondary" type="button" onclick="capturePanoramica()">üì∑ Scatta</button>
        <button class="btn small secondary" type="button" onclick="pickPanoramica()">üñº Carica</button>
        <button class="btn small danger" type="button" onclick="clearPhotosBySection('PANORAMICA')">üóë Elimina</button>
      </div>
      <ul class="photo-list" id="panoramicaList"></ul>
    </details>
  </section>

  <!-- UNITA -->
  <section class="card unita" id="unitaCard">
    <details open>
      <summary>UNITA</summary>
      <div class="hint">*Ogni UNITA √® definita da PIANO + NOME. Dentro puoi aggiungere uno o pi√π LOCALI.*</div>
      <div id="unitaContainer"></div>

      <div style="margin-top:10px">
        <button class="btn ok" type="button" onclick="addUnita()">+ AGGIUNGI UNITA</button>
      </div>
    </details>
  </section>

  <!-- RIEPILOGO -->
  <section class="card summary" id="summaryCard">
    <details open>
      <summary>RIEPILOGO FOTO</summary>
      <div class="hint">*Elenco di tutte le foto caricate (panoramica + unit√†/locali).*</div>
      <ul class="photo-list" id="allPhotosList"></ul>
    </details>
  </section>

  <div class="toast" id="toast"></div>

  <div class="bottombar">
    <button class="btn secondary" type="button" onclick="refreshUI()">AGGIORNA</button>
    <button class="btn ok" type="button" onclick="shareZip()">CONDIVIDI</button>
    <button class="btn secondary" type="button" onclick="saveDraft()">SALVA</button>
    <button class="btn secondary" type="button" onclick="loadDraft()">RIPRENDI</button>
    <button class="btn danger" type="button" onclick="deleteDraft()">ELIMINA</button>
  </div>

<script>
/* ============================
   SOPRALLUOGHI - ZIP + REPORT
   Report nel ZIP:
   - report.json (tutti i campi e selezioni)
   - report.txt  (testo leggibile)
   Foto nel ZIP: /FOTO/*
   ============================ */

  const DB_NAME = "sopralluoghi_offline";
  const DB_STORE = "draft";
  const DB_VER = 1;

  let panoPickInput, panoCapInput;
  let state = {
    version: "v36r",
    createdAt: new Date().toISOString(),
    pratica: "",
    assicurato: "",
    tagRef: "",
    indirizzo: "",
    gps: null,
    tipologia: "",
    tipologiaAltro: "",
    numUI: 0,
    volumi: [
      { destinazione: "Residenziale", piani: 0 },
      { destinazione: "Interrato e pertinenze", piani: 0 }
    ],
    costruttive: [],
    finiture: "",
    cantiere: "",
    ascensore: false,
    fv: false,
    unita: [],
    photos: [] // {id, section, fileName, originalName, mime, size, createdAt, meta:{...}, dataUrl}
  };

  const defaultLocali = ["Bagno","Cucina","Camera","Soggiorno","Corridoio","Ingresso","Balcone","Terrazzo","Tetto","Facciata","Altro"];
  const defaultDanni = ["Danni AC","RRG","Cristallo","Guasti ladri","Altro"];

  function uid(){
    return Math.random().toString(16).slice(2)+Date.now().toString(16);
  }
  function toast(msg){
    const t=document.getElementById("toast");
    t.textContent=msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }

  function sanitize(s){ return (s||"").toString().replace(/[^a-zA-Z0-9_\-]/g,"_"); }

  function clipPart(s,maxLen){
    const t=(s||"").toString().trim();
    if(!t) return "";
    const clean=sanitize(t);
    return clean.length>maxLen ? clean.slice(0,maxLen) : clean;
  }

  function getZipBaseName(){
    const pratica = clipPart((document.getElementById("praticaId")||{}).value, 30);
    const assicurato = clipPart((document.getElementById("assicurato")||{}).value, 30);
    const parts = ["sopralluogo"].concat([pratica, assicurato].filter(Boolean));
    return parts.join("_");
  }

  async function pasteTo(id){
    const el=document.getElementById(id);
    if(!el) return;
    try{
      const txt = (await navigator.clipboard.readText()) || "";
      if(txt){
        el.value = txt.trim();
        syncFromUI();
        toast("Incollato");
      } else {
        toast("Clipboard vuota");
      }
    }catch(e){
      const val = prompt("Incolla qui:");
      if(val!=null){
        el.value = val.trim();
        syncFromUI();
        toast("Incollato");
      }
    }
  }

  function stepNumber(id,delta){
    const el=document.getElementById(id);
    if(!el) return;
    const cur = parseInt(el.value||"0",10);
    el.value = (isNaN(cur)?0:cur) + delta;
    syncFromUI();
  }

  function getRadio(name){
    const sel=document.querySelector(`input[name="${name}"]:checked`);
    return sel ? sel.value : "";
  }
  function getChecks(containerId){
    const wrap=document.getElementById(containerId);
    if(!wrap) return [];
    return [...wrap.querySelectorAll('input[type="checkbox"]:checked')].map(x=>x.value);
  }

  function syncFromUI(){
    state.pratica = (document.getElementById("praticaId")||{}).value || "";
    state.assicurato = (document.getElementById("assicurato")||{}).value || "";
    state.tagRef = (document.getElementById("tagRef")||{}).value || "";
    state.indirizzo = (document.getElementById("indirizzo")||{}).value || "";
    state.tipologia = getRadio("tipologia");
    state.tipologiaAltro = (document.getElementById("tipologiaAltro")||{}).value || "";
    state.numUI = parseInt((document.getElementById("numUI")||{}).value || "0",10) || 0;

    state.volumi[0].destinazione = (document.getElementById("dest1")||{}).value || "";
    state.volumi[0].piani = parseInt((document.getElementById("piani1")||{}).value || "0",10) || 0;
    state.volumi[1].destinazione = (document.getElementById("dest2")||{}).value || "";
    state.volumi[1].piani = parseInt((document.getElementById("piani2")||{}).value || "0",10) || 0;

    state.costruttive = getChecks("costrOpts");
    state.finiture = (document.getElementById("finiture")||{}).value || "";
    state.cantiere = (document.getElementById("cantiere")||{}).value || "";
    state.ascensore = !!(document.getElementById("ascensore")||{}).checked;
    state.fv = !!(document.getElementById("fv")||{}).checked;

    renderAllPhotosList();
  }

  function refreshUI(){
    syncFromUI();
    renderAllPhotosList();
    toast("Aggiornato");
  }

  /* ======== GPS ======== */
  function getLocation(){
    if(!navigator.geolocation){
      toast("GPS non disponibile");
      return;
    }
    navigator.geolocation.getCurrentPosition((pos)=>{
      const {latitude, longitude, accuracy} = pos.coords;
      state.gps = {latitude, longitude, accuracy, ts:new Date().toISOString()};
      const indir=document.getElementById("indirizzo");
      if(indir && !indir.value.trim()){
        indir.value = `GPS: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
      }
      const info=document.getElementById("gpsInfo");
      if(info){
        info.textContent = `Coordinate: ${latitude.toFixed(6)}, ${longitude.toFixed(6)} (¬±${Math.round(accuracy)}m)`;
      }
      syncFromUI();
      toast("Posizione rilevata");
    }, ()=>{
      toast("Impossibile rilevare posizione");
    }, {enableHighAccuracy:true, timeout:8000});
  }

  /* ======== PANORAMICA FOTO ======== */
  function ensurePanoInputs(){
    if(!panoPickInput){
      panoPickInput=document.createElement("input");
      panoPickInput.type="file";
      panoPickInput.accept="image/*";
      panoPickInput.multiple=true;
      panoPickInput.addEventListener("change", async (e)=>{
        const files=[...e.target.files||[]];
        if(files.length) await addFilesToSection("PANORAMICA", files, {kind:"pick"});
        panoPickInput.value="";
      });
    }
    if(!panoCapInput){
      panoCapInput=document.createElement("input");
      panoCapInput.type="file";
      panoCapInput.accept="image/*";
      panoCapInput.capture="environment";
      panoCapInput.multiple=true;
      panoCapInput.addEventListener("change", async (e)=>{
        const files=[...e.target.files||[]];
        if(files.length) await addFilesToSection("PANORAMICA", files, {kind:"capture"});
        panoCapInput.value="";
      });
    }
  }
  function pickPanoramica(){ ensurePanoInputs(); panoPickInput.click(); }
  function capturePanoramica(){ ensurePanoInputs(); panoCapInput.click(); }

  function clearPhotosBySection(section){
    const before=state.photos.length;
    state.photos = state.photos.filter(p=>p.section!==section);
    if(before!==state.photos.length){
      renderSectionPhotoList(section);
      renderAllPhotosList();
      saveDraftSilent();
      toast("Foto eliminate");
    }
  }

  function renderSectionPhotoList(section){
    const ul = (section==="PANORAMICA") ? document.getElementById("panoramicaList") : document.getElementById(section);
    if(!ul) return;

    const list = state.photos.filter(p=>p.section===section);
    ul.innerHTML="";
    list.forEach((p,idx)=>{
      const li=document.createElement("li");
      const left=document.createElement("div");
      left.className="photo-name";
      left.textContent = p.fileName;
      const actions=document.createElement("div");
      actions.className="photo-actions";

      const del=document.createElement("button");
      del.className="iconbtn danger";
      del.type="button";
      del.title="Elimina";
      del.innerHTML = trashSvg();
      del.onclick=()=>{
        state.photos = state.photos.filter(x=>x.id!==p.id);
        renderSectionPhotoList(section);
        renderAllPhotosList();
        saveDraftSilent();
      };

      actions.appendChild(del);
      li.appendChild(left);
      li.appendChild(actions);
      ul.appendChild(li);
    });
  }

  function renderAllPhotosList(){
    const ul=document.getElementById("allPhotosList");
    if(!ul) return;
    ul.innerHTML="";
    if(state.photos.length===0){
      const li=document.createElement("li");
      li.style.padding="10px";
      li.className="muted";
      li.textContent="Nessuna foto caricata";
      ul.appendChild(li);
      return;
    }
    state.photos.forEach(p=>{
      const li=document.createElement("li");
      const left=document.createElement("div");
      left.className="photo-name";
      left.textContent = `${p.fileName} `;
      const right=document.createElement("span");
      right.className="badge";
      right.textContent = p.section;
      li.appendChild(left);
      li.appendChild(right);
      ul.appendChild(li);
    });
  }

  /* ======== UNITA + LOCALI ======== */
  function addUnita(){
    const u = {
      id: uid(),
      nome: "",
      piano: 0,
      locali: []
    };
    state.unita.push(u);
    renderUnita();
    saveDraftSilent();
  }

  function removeUnita(unitaId){
    state.unita = state.unita.filter(u=>u.id!==unitaId);
    // rimuovi anche foto collegate
    state.photos = state.photos.filter(p=>!p.section.startsWith(`U_${unitaId}_`));
    renderUnita();
    renderAllPhotosList();
    saveDraftSilent();
  }

  function addLocale(unitaId){
    const u = state.unita.find(x=>x.id===unitaId);
    if(!u) return;
    const l = {
      id: uid(),
      nome: "",
      localeSel: "",
      localeAltro: "",
      danniSel: [],
      note: ""
    };
    u.locali.push(l);
    renderUnita();
    saveDraftSilent();
  }

  function removeLocale(unitaId, localeId){
    const u=state.unita.find(x=>x.id===unitaId);
    if(!u) return;
    u.locali = u.locali.filter(l=>l.id!==localeId);
    // rimuovi foto collegate a quel locale
    state.photos = state.photos.filter(p=>p.section!==photoSectionFor(unitaId, localeId));
    renderUnita();
    renderAllPhotosList();
    saveDraftSilent();
  }

  function photoSectionFor(unitaId, localeId){
    return `U_${unitaId}_L_${localeId}`;
  }

  function buildPhotoFileName(meta, idx){
    // Formato: -PIANO NOME LOCALE DANNO - NR
    const piano = clipPart(meta.piano, 8);
    const nome = clipPart(meta.nome, 20);
    const locale = clipPart(meta.locale, 18);
    const danno = clipPart(meta.danno, 18);
    const n = String(idx).padStart(2,"0");
    const parts = ["-"+[piano,nome,locale,danno].filter(Boolean).join(" ")].join("");
    return `${parts} - ${n}.jpg`.replace(/\s+/g," ").trim();
  }

  async function addFilesToSection(section, files, meta){
    // meta: {kind, ...}
    for(const f of files){
      const dataUrl = await fileToDataUrl(f);
      const p = {
        id: uid(),
        section,
        originalName: f.name,
        mime: f.type || "image/jpeg",
        size: f.size || 0,
        createdAt: new Date().toISOString(),
        meta: meta || {},
        fileName: (section==="PANORAMICA")
          ? `-PANORAMICA - ${String(nextIndexForSection(section)).padStart(2,"0")}.jpg`
          : `-${section} - ${String(nextIndexForSection(section)).padStart(2,"0")}.jpg`,
        dataUrl
      };
      state.photos.push(p);
    }
    renderSectionPhotoList(section);
    renderAllPhotosList();
    saveDraftSilent();
    toast("Foto aggiunte");
  }

  function nextIndexForSection(section){
    return state.photos.filter(p=>p.section===section).length + 1;
  }

  function fileToDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=()=>resolve(r.result);
      r.onerror=reject;
      r.readAsDataURL(file);
    });
  }

  function renderUnita(){
    const wrap=document.getElementById("unitaContainer");
    if(!wrap) return;
    wrap.innerHTML="";

    if(state.unita.length===0){
      const p=document.createElement("div");
      p.className="muted";
      p.textContent="Nessuna unit√† inserita";
      wrap.appendChild(p);
      return;
    }

    state.unita.forEach((u,uiIdx)=>{
      const card=document.createElement("div");
      card.className="card";
      card.style.background="#fff";

      // header riga unica
      const hdr=document.createElement("div");
      hdr.className="row nowrap";
      hdr.style.justifyContent="space-between";

      const left=document.createElement("div");
      left.className="row nowrap";
      left.style.flex="1";
      left.style.gap="8px";
      left.style.alignItems="center";

      const btnDel=document.createElement("button");
      btnDel.className="iconbtn danger";
      btnDel.type="button";
      btnDel.title="Elimina unit√†";
      btnDel.innerHTML=trashSvg();
      btnDel.onclick=()=>removeUnita(u.id);

      const nameInp=document.createElement("input");
      nameInp.type="text";
      nameInp.placeholder="Nome (es. Rossi)";
      nameInp.value=u.nome||"";
      nameInp.oninput=()=>{
        u.nome=nameInp.value;
        syncFromUI();
        // rinomina foto dei locali collegati (se meta disponibile)
        autoRenameUnitPhotos(u.id);
        saveDraftSilent();
        renderUnita(); // aggiornamento titoli
      };

      const pianoWrap=document.createElement("div");
      pianoWrap.className="counter";
      pianoWrap.style.flex="0 0 auto";

      const bMinus=document.createElement("button");
      bMinus.className="btn small secondary";
      bMinus.type="button";
      bMinus.textContent="-";
      bMinus.onclick=()=>{
        u.piano=(parseInt(u.piano||0,10)||0)-1;
        saveDraftSilent();
        autoRenameUnitPhotos(u.id);
        renderUnita();
      };

      const pianoInp=document.createElement("input");
      pianoInp.type="number";
      pianoInp.value=u.piano||0;
      pianoInp.style.maxWidth="70px";
      pianoInp.oninput=()=>{
        u.piano=parseInt(pianoInp.value||"0",10)||0;
        saveDraftSilent();
        autoRenameUnitPhotos(u.id);
        renderUnita();
      };

      const bPlus=document.createElement("button");
      bPlus.className="btn small secondary";
      bPlus.type="button";
      bPlus.textContent="+";
      bPlus.onclick=()=>{
        u.piano=(parseInt(u.piano||0,10)||0)+1;
        saveDraftSilent();
        autoRenameUnitPhotos(u.id);
        renderUnita();
      };

      pianoWrap.appendChild(bMinus);
      pianoWrap.appendChild(pianoInp);
      pianoWrap.appendChild(bPlus);

      left.appendChild(btnDel);
      left.appendChild(tagSpan(`UNITA ${uiIdx+1}`));
      left.appendChild(nameInp);
      left.appendChild(tagSpan(`PIANO`));
      left.appendChild(pianoWrap);

      hdr.appendChild(left);
      card.appendChild(hdr);

      const titleLine=document.createElement("div");
      titleLine.className="mini";
      titleLine.style.margin="6px 0 10px";
      titleLine.textContent = `Titolo: ${formatUnitaTitle(u, uiIdx)}`;
      card.appendChild(titleLine);

      // locali
      const localiWrap=document.createElement("div");
      localiWrap.style.marginTop="8px";

      if(!u.locali || u.locali.length===0){
        const m=document.createElement("div");
        m.className="muted";
        m.textContent="Nessun locale inserito";
        localiWrap.appendChild(m);
      } else {
        u.locali.forEach((l,liIdx)=>{
          const det=document.createElement("details");
          det.open=true;

          const sum=document.createElement("summary");
          sum.textContent = `LOCALE ${liIdx+1}`;
          det.appendChild(sum);

          const inner=document.createElement("div");
          inner.style.marginTop="8px";

          const badge=document.createElement("div");
          badge.className="badge";
          badge.textContent = `Unit√†: ${formatUnitaTitle(u, uiIdx)}`;
          inner.appendChild(badge);

          const row1=document.createElement("div");
          row1.className="row";
          row1.style.marginTop="8px";

          const colLocale=document.createElement("div");
          colLocale.className="col";
          const labL=document.createElement("label");
          labL.textContent="LOCALE";
          colLocale.appendChild(labL);

          const sel=document.createElement("select");
          const opt0=document.createElement("option");
          opt0.value=""; opt0.textContent="-";
          sel.appendChild(opt0);
          defaultLocali.forEach(x=>{
            const o=document.createElement("option");
            o.value=x; o.textContent=x;
            sel.appendChild(o);
          });
          sel.value=l.localeSel||"";
          sel.onchange=()=>{
            l.localeSel=sel.value;
            autoRenameLocalePhotos(u, l);
            saveDraftSilent();
          };
          colLocale.appendChild(sel);

          const altroInp=document.createElement("input");
          altroInp.type="text";
          altroInp.placeholder="Altro locale (libero)";
          altroInp.value=l.localeAltro||"";
          altroInp.oninput=()=>{
            l.localeAltro=altroInp.value;
            autoRenameLocalePhotos(u, l);
            saveDraftSilent();
          };
          colLocale.appendChild(altroInp);

          const colD=document.createElement("div");
          colD.className="col";
          const labD=document.createElement("label");
          labD.textContent="TIPO DI DANNO";
          colD.appendChild(labD);

          const danniBox=document.createElement("div");
          danniBox.className="opts";
          defaultDanni.forEach(d=>{
            const wrapOpt=document.createElement("label");
            wrapOpt.className="opt";
            const cb=document.createElement("input");
            cb.type="checkbox";
            cb.value=d;
            cb.checked=(l.danniSel||[]).includes(d);
            cb.onchange=()=>{
              if(cb.checked){
                l.danniSel=[...(l.danniSel||[]), d];
              }else{
                l.danniSel=(l.danniSel||[]).filter(x=>x!==d);
              }
              autoRenameLocalePhotos(u,l);
              saveDraftSilent();
            };
            wrapOpt.appendChild(cb);
            wrapOpt.appendChild(document.createTextNode(" "+d));
            danniBox.appendChild(wrapOpt);
          });
          colD.appendChild(danniBox);

          const colNote=document.createElement("div");
          colNote.className="col";
          const labN=document.createElement("label");
          labN.textContent="NOTE";
          colNote.appendChild(labN);
          const ta=document.createElement("textarea");
          ta.placeholder="Note libere...";
          ta.value=l.note||"";
          ta.oninput=()=>{
            l.note=ta.value;
            saveDraftSilent();
          };
          colNote.appendChild(ta);

          row1.appendChild(colLocale);
          row1.appendChild(colD);
          row1.appendChild(colNote);

          inner.appendChild(row1);

          // foto tools locale
          const section = photoSectionFor(u.id, l.id);
          const tools=document.createElement("div");
          tools.className="photo-tools";
          tools.style.marginTop="10px";

          const bCap=document.createElement("button");
          bCap.className="btn small secondary";
          bCap.type="button";
          bCap.textContent="üì∑ Scatta";
          bCap.onclick=()=>captureForLocale(u, l);

          const bPick=document.createElement("button");
          bPick.className="btn small secondary";
          bPick.type="button";
          bPick.textContent="üñº Carica";
          bPick.onclick=()=>pickForLocale(u, l);

          const bDelAll=document.createElement("button");
          bDelAll.className="btn small danger";
          bDelAll.type="button";
          bDelAll.textContent="üóë Elimina";
          bDelAll.onclick=()=>clearPhotosBySection(section);

          const bRefresh=document.createElement("button");
          bRefresh.className="btn small secondary";
          bRefresh.type="button";
          bRefresh.textContent="‚Üª Aggiorna nomi";
          bRefresh.onclick=()=>{
            autoRenameLocalePhotos(u,l, true);
            saveDraftSilent();
            toast("Nomi aggiornati");
            renderSectionPhotoList(section);
            renderAllPhotosList();
          };

          tools.appendChild(bCap);
          tools.appendChild(bPick);
          tools.appendChild(bDelAll);
          tools.appendChild(bRefresh);

          inner.appendChild(tools);

          // lista foto locale
          const ul=document.createElement("ul");
          ul.className="photo-list";
          ul.id=section;
          inner.appendChild(ul);

          det.appendChild(inner);

          // elimina locale button
          const rm=document.createElement("button");
          rm.className="btn small danger";
          rm.type="button";
          rm.style.marginTop="8px";
          rm.textContent="Elimina locale";
          rm.onclick=()=>removeLocale(u.id, l.id);
          det.appendChild(rm);

          localiWrap.appendChild(det);

          // render lista foto sezione
          setTimeout(()=>renderSectionPhotoList(section),0);
        });
      }

      card.appendChild(localiWrap);

      const addBtn=document.createElement("button");
      addBtn.className="btn ok";
      addBtn.type="button";
      addBtn.style.marginTop="10px";
      addBtn.textContent="+ AGGIUNGI LOCALE";
      addBtn.onclick=()=>addLocale(u.id);
      card.appendChild(addBtn);

      wrap.appendChild(card);
    });

    renderAllPhotosList();
  }

  function tagSpan(txt){
    const s=document.createElement("span");
    s.className="badge";
    s.textContent=txt;
    return s;
  }

  function formatUnitaTitle(u, idx){
    const nome = (u.nome||"").trim();
    const piano = (u.piano!=null?String(u.piano):"").trim();
    const parts=[];
    if(piano) parts.push(piano+"¬∞");
    if(nome) parts.push(nome);
    if(parts.length===0) return `UNITA ${idx+1}`;
    return parts.join(" ");
  }

  function localeLabel(l, liIdx){
    const base = (l.localeSel||"").trim() || (l.localeAltro||"").trim();
    return base ? `${base}` : `LOCALE ${liIdx+1}`;
  }

  function getPrimaryDanno(l){
    const arr=l.danniSel||[];
    if(arr.length===0) return "";
    // scegli primo non "Altro" se presente
    const first=arr.find(x=>x!=="Altro") || arr[0];
    return first;
  }

  function autoRenameUnitPhotos(unitaId){
    const u=state.unita.find(x=>x.id===unitaId);
    if(!u) return;
    (u.locali||[]).forEach(l=>{
      autoRenameLocalePhotos(u,l,false);
    });
  }

  function autoRenameLocalePhotos(u,l, force){
    const section=photoSectionFor(u.id, l.id);
    const photos=state.photos.filter(p=>p.section===section);
    if(photos.length===0) return;

    const meta = {
      piano: String(u.piano||""),
      nome: (u.nome||"").trim(),
      locale: (l.localeSel||"").trim() || (l.localeAltro||"").trim(),
      danno: getPrimaryDanno(l)
    };

    photos.forEach((p,idx)=>{
      const newName=buildPhotoFileName(meta, idx+1);
      if(force || !p.fileName || p.fileName.startsWith("-U_")){
        p.fileName=newName;
      } else {
        // aggiorna comunque (richiesto)
        p.fileName=newName;
      }
      p.meta = {...(p.meta||{}), ...meta};
    });

    renderSectionPhotoList(section);
    renderAllPhotosList();
  }

  function ensureLocaleInputs(obj, kind){
    if(!obj._pick){
      obj._pick=document.createElement("input");
      obj._pick.type="file";
      obj._pick.accept="image/*";
      obj._pick.multiple=true;
      obj._pick.addEventListener("change", async (e)=>{
        const files=[...e.target.files||[]];
        if(files.length) await handleLocaleFiles(obj, files, {kind:"pick"});
        obj._pick.value="";
      });
    }
    if(!obj._cap){
      obj._cap=document.createElement("input");
      obj._cap.type="file";
      obj._cap.accept="image/*";
      obj._cap.capture="environment";
      obj._cap.multiple=true;
      obj._cap.addEventListener("change", async (e)=>{
        const files=[...e.target.files||[]];
        if(files.length) await handleLocaleFiles(obj, files, {kind:"capture"});
        obj._cap.value="";
      });
    }
  }

  async function handleLocaleFiles(ctx, files, meta){
    // ctx: {u,l}
    const u=ctx.u, l=ctx.l;
    const section=photoSectionFor(u.id, l.id);
    const beforeCount=state.photos.filter(p=>p.section===section).length;

    for(const f of files){
      const dataUrl=await fileToDataUrl(f);
      const p={
        id:uid(),
        section,
        originalName:f.name,
        mime:f.type||"image/jpeg",
        size:f.size||0,
        createdAt:new Date().toISOString(),
        meta:{...(meta||{})},
        fileName:"", // viene settato sotto
        dataUrl
      };
      state.photos.push(p);
    }

    // rinomina in base ai meta attuali locale
    autoRenameLocalePhotos(u,l,true);

    renderSectionPhotoList(section);
    renderAllPhotosList();
    saveDraftSilent();
    toast("Foto aggiunte");
  }

  function pickForLocale(u,l){
    const ctx={u,l};
    ensureLocaleInputs(ctx);
    ctx._pick.click();
  }
  function captureForLocale(u,l){
    const ctx={u,l};
    ensureLocaleInputs(ctx);
    ctx._cap.click();
  }

  /* ======== DRAFT OFFLINE (IndexedDB) ======== */
  function openDB(){
    return new Promise((resolve,reject)=>{
      const req=indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded=()=>{
        const db=req.result;
        if(!db.objectStoreNames.contains(DB_STORE)){
          db.createObjectStore(DB_STORE);
        }
      };
      req.onsuccess=()=>resolve(req.result);
      req.onerror=()=>reject(req.error);
    });
  }

  async function idbSet(key, value){
    const db=await openDB();
    return new Promise((resolve,reject)=>{
      const tx=db.transaction(DB_STORE,"readwrite");
      tx.objectStore(DB_STORE).put(value, key);
      tx.oncomplete=()=>resolve();
      tx.onerror=()=>reject(tx.error);
    });
  }

  async function idbGet(key){
    const db=await openDB();
    return new Promise((resolve,reject)=>{
      const tx=db.transaction(DB_STORE,"readonly");
      const req=tx.objectStore(DB_STORE).get(key);
      req.onsuccess=()=>resolve(req.result);
      req.onerror=()=>reject(req.error);
    });
  }

  async function idbDel(key){
    const db=await openDB();
    return new Promise((resolve,reject)=>{
      const tx=db.transaction(DB_STORE,"readwrite");
      tx.objectStore(DB_STORE).delete(key);
      tx.oncomplete=()=>resolve();
      tx.onerror=()=>reject(tx.error);
    });
  }

  async function saveDraft(){
    syncFromUI();
    state.updatedAt = new Date().toISOString();
    await idbSet("draft", JSON.stringify(state));
    toast("Bozza salvata");
  }

  async function saveDraftSilent(){
    try{
      syncFromUI();
      state.updatedAt = new Date().toISOString();
      await idbSet("draft", JSON.stringify(state));
    }catch(e){
      // ignore
    }
  }

  async function loadDraft(){
    try{
      const raw=await idbGet("draft");
      if(!raw){ toast("Nessuna bozza"); return; }
      const obj=JSON.parse(raw);
      state = obj;
      applyToUI();
      renderUnita();
      renderSectionPhotoList("PANORAMICA");
      renderAllPhotosList();
      toast("Bozza ripristinata");
    }catch(e){
      toast("Errore ripristino bozza");
    }
  }

  async function deleteDraft(){
    if(!confirm("Eliminare la bozza salvata?")) return;
    await idbDel("draft");
    toast("Bozza eliminata");
  }

  function applyToUI(){
    (document.getElementById("praticaId")||{}).value = state.pratica||"";
    (document.getElementById("assicurato")||{}).value = state.assicurato||"";
    (document.getElementById("tagRef")||{}).value = state.tagRef||"";
    (document.getElementById("indirizzo")||{}).value = state.indirizzo||"";
    (document.getElementById("tipologiaAltro")||{}).value = state.tipologiaAltro||"";
    (document.getElementById("numUI")||{}).value = state.numUI||0;

    // radio tipologia
    document.querySelectorAll('input[name="tipologia"]').forEach(r=>{
      r.checked = (r.value === (state.tipologia||""));
    });

    (document.getElementById("dest1")||{}).value = state.volumi?.[0]?.destinazione ?? "Residenziale";
    (document.getElementById("piani1")||{}).value = state.volumi?.[0]?.piani ?? 0;
    (document.getElementById("dest2")||{}).value = state.volumi?.[1]?.destinazione ?? "Interrato e pertinenze";
    (document.getElementById("piani2")||{}).value = state.volumi?.[1]?.piani ?? 0;

    // costruttive
    document.querySelectorAll('#costrOpts input[type="checkbox"]').forEach(c=>{
      c.checked = (state.costruttive||[]).includes(c.value);
    });

    (document.getElementById("finiture")||{}).value = state.finiture||"";
    (document.getElementById("cantiere")||{}).value = state.cantiere||"";
    (document.getElementById("ascensore")||{}).checked = !!state.ascensore;
    (document.getElementById("fv")||{}).checked = !!state.fv;

    // gps info
    const info=document.getElementById("gpsInfo");
    if(info){
      if(state.gps?.latitude){
        info.textContent = `Coordinate: ${Number(state.gps.latitude).toFixed(6)}, ${Number(state.gps.longitude).toFixed(6)} (¬±${Math.round(state.gps.accuracy||0)}m)`;
      } else info.textContent="";
    }
  }

  /* ======== REPORT ======== */
  function buildReportObject(){
    syncFromUI();

    const report = {
      appVersion: state.version || "",
      createdAt: state.createdAt || "",
      updatedAt: state.updatedAt || "",
      pratica: state.pratica || "",
      assicurato: state.assicurato || "",
      riferimentoTag: state.tagRef || "",
      indirizzo: state.indirizzo || "",
      gps: state.gps || null,
      tipologiaFabbricato: state.tipologia || "",
      tipologiaAltro: state.tipologiaAltro || "",
      numeroUI: state.numUI || 0,
      volumi: state.volumi || [],
      caratteristicheCostruttive: state.costruttive || [],
      finiture: state.finiture || "",
      cantiere: state.cantiere || "",
      ascensore: !!state.ascensore,
      pannelliFV: !!state.fv,
      unita: (state.unita||[]).map((u,idx)=>({
        index: idx+1,
        nome: u.nome||"",
        piano: u.piano||0,
        titolo: formatUnitaTitle(u, idx),
        locali: (u.locali||[]).map((l,li)=>({
          index: li+1,
          locale: (l.localeSel||"") || "",
          localeAltro: l.localeAltro||"",
          danni: l.danniSel||[],
          note: l.note||"",
          photoSection: photoSectionFor(u.id,l.id)
        }))
      })),
      photos: (state.photos||[]).map(p=>({
        section: p.section,
        fileName: p.fileName,
        originalName: p.originalName,
        mime: p.mime,
        size: p.size,
        createdAt: p.createdAt,
        meta: p.meta || {}
      }))
    };

    return report;
  }

  function buildReportText(obj){
    const lines=[];
    lines.push("REPORT SOPRALLUOGO");
    lines.push(`Versione app: ${obj.appVersion||""}`);
    lines.push(`Creato: ${obj.createdAt||""}`);
    lines.push(`Aggiornato: ${obj.updatedAt||""}`);
    lines.push("");
    lines.push(`Pratica/Sinistro: ${obj.pratica||""}`);
    lines.push(`Assicurato: ${obj.assicurato||""}`);
    lines.push(`Tag: ${obj.riferimentoTag||""}`);
    lines.push(`Indirizzo: ${obj.indirizzo||""}`);
    if(obj.gps?.latitude){
      lines.push(`GPS: ${obj.gps.latitude}, ${obj.gps.longitude} (¬±${obj.gps.accuracy||""}m)`);
    }
    lines.push("");
    lines.push("PANORAMICA RISCHIO");
    lines.push(`Tipologia: ${obj.tipologiaFabbricato||""} ${obj.tipologiaAltro?("("+obj.tipologiaAltro+")"):""}`);
    lines.push(`Numero U.I.: ${obj.numeroUI||0}`);
    lines.push("Volumi:");
    (obj.volumi||[]).forEach((v,i)=>{
      lines.push(`- ${i+1}) ${v.destinazione||""} | piani: ${v.piani||0}`);
    });
    lines.push(`Caratteristiche: ${(obj.caratteristicheCostruttive||[]).join(", ")}`);
    lines.push(`Finiture: ${obj.finiture||""}`);
    lines.push(`Cantiere: ${obj.cantiere||""}`);
    lines.push(`Ascensore: ${obj.ascensore?"SI":"NO"}`);
    lines.push(`Pannelli FV: ${obj.pannelliFV?"SI":"NO"}`);
    lines.push("");
    lines.push("UNITA / LOCALI");
    (obj.unita||[]).forEach(u=>{
      lines.push(`- UNITA ${u.index}: ${u.titolo}`);
      (u.locali||[]).forEach(l=>{
        const loc = l.locale || l.localeAltro || `LOCALE ${l.index}`;
        lines.push(`  - LOCALE ${l.index}: ${loc}`);
        lines.push(`    Danni: ${(l.danni||[]).join(", ")}`);
        if(l.note) lines.push(`    Note: ${l.note}`);
        lines.push(`    Sezione foto: ${l.photoSection}`);
      });
    });
    lines.push("");
    lines.push("FOTO");
    (obj.photos||[]).forEach(p=>{
      lines.push(`- ${p.fileName} | section: ${p.section} | orig: ${p.originalName}`);
    });
    return lines.join("\n");
  }

  /* ======== ZIP + SHARE ======== */
  async function shareZip(){
    try{
      syncFromUI();

      const zip = new JSZip();
      const folder = zip.folder("FOTO");

      // report
      let reportObj=null, reportTxt=null;
      try{
        reportObj = buildReportObject();
        reportTxt = buildReportText(reportObj);
        zip.file("report.json", JSON.stringify(reportObj, null, 2));
        zip.file("report.txt", reportTxt);
      }catch(e){
        zip.file("report_error.txt", String(e));
      }

      // foto
      const photos=state.photos||[];
      for(const p of photos){
        const blob = dataUrlToBlob(p.dataUrl, p.mime);
        folder.file(p.fileName || (p.originalName||("foto_"+p.id+".jpg")), blob);
      }

      const blob = await zip.generateAsync({type:"blob"});
      const base = getZipBaseName();
      const ts = new Date().toISOString().replace(/[:.]/g,"-");
      const fileName = `${base}_${ts}.zip`;

      const file = new File([blob], fileName, {type:"application/zip"});

      // share api
      if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
        await navigator.share({files:[file], title:"Sopralluogo", text:"ZIP sopralluogo"});
        toast("Condiviso");
        return;
      }

      // fallback download
      downloadBlob(blob, fileName);
      toast("Condivisione non disponibile: scaricato ZIP");
    }catch(e){
      console.error(e);
      toast("Errore generazione ZIP");
    }
  }

  function dataUrlToBlob(dataUrl, mime){
    if(!dataUrl) return new Blob([], {type:mime||"application/octet-stream"});
    const parts=dataUrl.split(",");
    const b64=parts[1] || "";
    const bin=atob(b64);
    const arr=new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
    return new Blob([arr], {type:mime||"image/jpeg"});
  }

  function downloadBlob(blob, name){
    const a=document.createElement("a");
    const url=URL.createObjectURL(blob);
    a.href=url;
    a.download=name;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{
      URL.revokeObjectURL(url);
      a.remove();
    }, 0);
  }

  /* ======== JSZip minimal (embed) ======== */
  /*! JSZip v3.10.1 - MIT - https://stuk.github.io/jszip/ */
  /* Minified build included (small) */
</script>

<!-- JSZip (min) -->
<script>
/* JSZip 3.10.1 - minified */
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).JSZip=e()}}(function(){return function(){var e={};function t(n){if(e[n])return e[n].exports;var r=e[n]={i:n,l:!1,exports:{}};return n.call(r.exports,r,r.exports,t),r.l=!0,r.exports}return t.m=[],t.c=e,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var o in e)t.d(r,o,function(t){return e[t]}.bind(null,o));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,n){e.exports=n(1)},function(e,t,n){/* trimmed for brevity in this message */throw new Error("JSZip minified content placeholder. Please keep your existing JSZip block in index.html.");}])}()});
</script>

<script>
  function trashSvg(){
    return `<svg viewBox="0 0 24 24" fill="none" stroke="#991b1b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 6h18"/>
      <path d="M8 6V4h8v2"/>
      <path d="M19 6l-1 14H6L5 6"/>
      <path d="M10 11v6"/>
      <path d="M14 11v6"/>
    </svg>`;
  }

  // init
  (function init(){
    ensurePanoInputs();
    document.querySelectorAll('#tipologiaOpts input[type="radio"]').forEach(r=>{
      r.addEventListener("change", ()=>{ syncFromUI(); saveDraftSilent(); });
    });
    document.querySelectorAll('#costrOpts input[type="checkbox"]').forEach(c=>{
      c.addEventListener("change", ()=>{ syncFromUI(); saveDraftSilent(); });
    });
    ["praticaId","assicurato","tagRef","indirizzo","tipologiaAltro","numUI","dest1","piani1","dest2","piani2","finiture","cantiere","ascensore","fv"]
      .forEach(id=>{
        const el=document.getElementById(id);
        if(!el) return;
        el.addEventListener("input", ()=>{ syncFromUI(); saveDraftSilent(); });
        el.addEventListener("change", ()=>{ syncFromUI(); saveDraftSilent(); });
      });

    // render initial
    renderUnita();
    renderSectionPhotoList("PANORAMICA");
    renderAllPhotosList();

    // try auto-load draft silently
    loadDraft().catch(()=>{});
  })();
</script>

</body>
</html>
